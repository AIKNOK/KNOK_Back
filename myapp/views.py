from rest_framework.decorators import api_view
from rest_framework.response import Response
import boto3
import hmac
import hashlib
import base64
from django.conf import settings


# ğŸ” SECRET_HASH ê³„ì‚° í•¨ìˆ˜
def get_secret_hash(username):
    message = username + settings.COGNITO_APP_CLIENT_ID
    digest = hmac.new(
        settings.COGNITO_APP_CLIENT_SECRET.encode('utf-8'),
        message.encode('utf-8'),
        hashlib.sha256
    ).digest()
    return base64.b64encode(digest).decode()


# ğŸ“ íšŒì›ê°€ì… API
@api_view(['POST'])
def signup(request):
    email = request.data.get('email')
    password = request.data.get('password')

    client = boto3.client('cognito-idp', region_name=settings.AWS_REGION)

    try:
        client.sign_up(
            ClientId=settings.COGNITO_APP_CLIENT_ID,
            SecretHash=get_secret_hash(email),
            Username=email,
            Password=password,
            UserAttributes=[
                {'Name': 'email', 'Value': email},
            ],
        )
        return Response({'message': 'íšŒì›ê°€ì… ì„±ê³µ! ì´ë©”ì¼ ì¸ì¦ í•„ìš”'})
    except client.exceptions.UsernameExistsException:
        return Response({'error': 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.'}, status=400)
    except Exception as e:
        return Response({'error': str(e)}, status=400)


# âœ… ì´ë©”ì¼ ì¸ì¦ API
@api_view(['POST'])
def confirm_email(request):
    email = request.data.get('email')
    code = request.data.get('code')

    client = boto3.client('cognito-idp', region_name=settings.AWS_REGION)

    try:
        client.confirm_sign_up(
            ClientId=settings.COGNITO_APP_CLIENT_ID,
            SecretHash=get_secret_hash(email),
            Username=email,
            ConfirmationCode=code
        )
        return Response({'message': 'ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ'})
    except client.exceptions.CodeMismatchException:
        return Response({'error': 'ì¸ì¦ ì½”ë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'}, status=400)
    except client.exceptions.ExpiredCodeException:
        return Response({'error': 'ì¸ì¦ ì½”ë“œê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'}, status=400)
    except Exception as e:
        return Response({'error': str(e)}, status=400)


# ğŸ”‘ ë¡œê·¸ì¸ API
@api_view(['POST'])
def login(request):
    email = request.data.get('email')
    password = request.data.get('password')

    client = boto3.client('cognito-idp', region_name=settings.AWS_REGION)

    try:
        response = client.initiate_auth(
            ClientId=settings.COGNITO_APP_CLIENT_ID,
            AuthFlow='USER_PASSWORD_AUTH',
            AuthParameters={
                'USERNAME': email,
                'PASSWORD': password,
                'SECRET_HASH': get_secret_hash(email)
            }
        )
        token = response['AuthenticationResult']['IdToken']
        return Response({
            'message': 'ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤',
            'token': token
        })
    except client.exceptions.NotAuthorizedException:
        return Response({'error': 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜'}, status=400)
    except Exception as e:
        return Response({'error': str(e)}, status=400)
